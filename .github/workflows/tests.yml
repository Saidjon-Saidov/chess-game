# GitHub Actions workflow –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
name: üß™ Chess Engine Tests

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å
on:
  push:
    branches: [ main, master, develop ]  # –ü—Ä–∏ –ø—É—à–µ –≤ —ç—Ç–∏ –≤–µ—Ç–∫–∏
  pull_request:
    branches: [ main, master ]           # –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PR

# –ó–∞–¥–∞—á–∏
jobs:
  test:
    name: üêç Python ${{ matrix.python-version }} –Ω–∞ ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    # –ú–∞—Ç—Ä–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –∑–∞–ø—É—Å—Ç–∏—Ç –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Python –∏ –û–°
    strategy:
      fail-fast: false  # –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–∏–Ω —Ç–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    # 1. –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - name: üêç Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'  # –ö—ç—à–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
    
    # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 4. –ó–∞–ø—É—Å–∫–∞–µ–º –ª–∏–Ω—Ç–µ—Ä (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞)
    - name: üé® Lint with flake8
      run: |
        pip install flake8
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true  # –ù–µ –ø–∞–¥–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∏–ª–µ–≤—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è
    
    # 5. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å coverage
    - name: üß™ Run tests with pytest
      run: |
        pytest test_chess_engine.py -v --cov=chess_game --cov-report=xml --cov-report=html
    
    # 6. –ó–∞–≥—Ä—É–∂–∞–µ–º coverage –æ—Ç—á—ë—Ç –≤ Codecov (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - name: üìä Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      continue-on-error: true
    
    # 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML –æ—Ç—á—ë—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
    - name: üìÅ Upload coverage HTML report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-report-${{ matrix.os }}-py${{ matrix.python-version }}
        path: htmlcov/
    
    # 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (smoke test)
    - name: üéÆ Smoke test - check game imports
      run: |
        python -c "from chess_game import ChessGame; print('‚úÖ Game imports successfully')"